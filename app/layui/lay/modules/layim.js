layui.define(["layer","laytpl","upload"],function(i){var a="3.7.6",r=layui.$,u=layui.layer,d=layui.laytpl,c=layui.device(),o="layui-show",y="layim-this",m={},e=function(){this.v=a,r("body").on("click","*[layim-event]",function(i){var a=r(this),e=a.attr("layim-event");ai[e]&&ai[e].call(this,a,i)})};e.prototype.config=function(i){var e=[];if(layui.each(Array(5),function(i){e.push(layui.cache.dir+"css/modules/layim/skin/"+(i+1)+".jpg")}),(i=i||{}).skin=i.skin||[],layui.each(i.skin,function(i,a){e.unshift(a)}),i.skin=e,i=r.extend({isfriend:!0,isgroup:!0,voice:"default.mp3"},i),window.JSON&&window.JSON.parse)return H(i),this},e.prototype.on=function(i,a){return"function"==typeof a&&(m[i]?m[i].push(a):m[i]=[a]),this},e.prototype.cache=function(){return j},e.prototype.chat=function(i){if(window.JSON&&window.JSON.parse)return z(i),this},e.prototype.setChatMin=function(){return N(),this},e.prototype.setChatStatus=function(i){var a=_();if(a)return a.elem.find(".layim-chat-status").html(i),this},e.prototype.getMessage=function(i){return F(i),this},e.prototype.notice=function(i){return J(i),this},e.prototype.add=function(i){return M(i),this},e.prototype.setFriendGroup=function(i){return M(i,"setGroup"),this},e.prototype.msgbox=function(i){return K(i),this},e.prototype.addList=function(i){return B(i),this},e.prototype.removeList=function(i){return U(i),this},e.prototype.setFriendStatus=function(i,a){r(".layim-friend"+i)["online"===a?"removeClass":"addClass"]("layim-list-gray")},e.prototype.content=function(i){return layui.data.content(i)};var f=function(i){return(i=i||{}).item=i.item||"d."+i.type,["{{# var length = 0; layui.each("+i.item+", function(i, data){ length++; }}",'<li layim-event="chat" data-type="'+i.type+'" data-index="{{ '+(i.index||"i")+' }}" class="layim-'+("history"===i.type?"{{i}}":i.type+"{{data.id}}")+' {{ data.status === "offline" ? "layim-list-gray" : "" }}"><img src="{{ data.avatar }}"><span>{{ data.username||data.groupname||data.name||"佚名" }}</span><p>{{ data.remark||data.sign||"" }}</p><span class="layim-msg-status">new</span></li>',"{{# }); if(length === 0){ }}",'<li class="layim-null">'+({friend:"该分组下暂无好友",group:"暂无群组",history:"暂无历史会话"}[i.type]||"暂无数据")+"</li>","{{# } }}"].join("")},l=['<div class="layui-layim-main">','<div class="layui-layim-info">','<div class="layui-layim-user">{{ d.mine.username }}</div>','<div class="layui-layim-status">','{{# if(d.mine.status === "online"){ }}','<span class="layui-icon layim-status-online" layim-event="status" lay-type="show">&#xe617;</span>','{{# } else if(d.mine.status === "hide") { }}','<span class="layui-icon layim-status-hide" layim-event="status" lay-type="show">&#xe60f;</span>',"{{# } }}",'<ul class="layui-anim layim-menu-box">','<li {{d.mine.status === "online" ? "class=layim-this" : ""}} layim-event="status" lay-type="online"><i class="layui-icon">&#xe618;</i><cite class="layui-icon layim-status-online">&#xe617;</cite>在线</li>','<li {{d.mine.status === "hide" ? "class=layim-this" : ""}} layim-event="status" lay-type="hide"><i class="layui-icon">&#xe618;</i><cite class="layui-icon layim-status-hide">&#xe60f;</cite>隐身</li>',"</ul>","</div>",'<input class="layui-layim-remark" placeholder="编辑签名" value="{{ d.mine.remark||d.mine.sign||"" }}">',"</div>",'<ul class="layui-unselect layui-layim-tab{{# if(!d.base.isfriend || !d.base.isgroup){ }}'," layim-tab-two",'{{# } }}">','<li class="layui-icon',"{{# if(!d.base.isfriend){ }}"," layim-hide","{{# } else { }}"," layim-this","{{# } }}",'" title="联系人" layim-event="tab" lay-type="friend">&#xe612;</li>','<li class="layui-icon',"{{# if(!d.base.isgroup){ }}"," layim-hide","{{# } else if(!d.base.isfriend) { }}"," layim-this","{{# } }}",'" title="群组" layim-event="tab" lay-type="group">&#xe613;</li>','<li class="layui-icon" title="历史会话" layim-event="tab" lay-type="history">&#xe611;</li>',"</ul>",'<ul class="layui-unselect layim-tab-content {{# if(d.base.isfriend){ }}layui-show{{# } }} layim-list-friend">','{{# layui.each(d.friend, function(index, item){ var spread = d.local["spread"+index]; }}',"<li>",'<h5 layim-event="spread" lay-type="{{ spread }}"><i class="layui-icon">{{# if(spread === "true"){ }}&#xe61a;{{# } else {  }}&#xe602;{{# } }}</i><span>{{ item.groupname||"未命名分组"+index }}</span><em>(<cite class="layim-count"> {{ (item.list||[]).length }}</cite>)</em></h5>','<ul class="layui-layim-list {{# if(spread === "true"){ }}'," layui-show",'{{# } }}">',f({type:"friend",item:"item.list",index:"index"}),"</ul>","</li>","{{# }); if(d.friend.length === 0){ }}",'<li><ul class="layui-layim-list layui-show"><li class="layim-null">暂无联系人</li></ul>',"{{# } }}","</ul>",'<ul class="layui-unselect layim-tab-content {{# if(!d.base.isfriend && d.base.isgroup){ }}layui-show{{# } }}">',"<li>",'<ul class="layui-layim-list layui-show layim-list-group">',f({type:"group"}),"</ul>","</li>","</ul>",'<ul class="layui-unselect layim-tab-content  {{# if(!d.base.isfriend && !d.base.isgroup){ }}layui-show{{# } }}">',"<li>",'<ul class="layui-layim-list layui-show layim-list-history">',f({type:"history"}),"</ul>","</li>","</ul>",'<ul class="layui-unselect layim-tab-content">',"<li>",'<ul class="layui-layim-list layui-show" id="layui-layim-search"></ul>',"</li>","</ul>",'<ul class="layui-unselect layui-layim-tool">','<li class="layui-icon layim-tool-search" layim-event="search" title="搜索">&#xe615;</li>',"{{# if(d.base.msgbox){ }}",'<li class="layui-icon layim-tool-msgbox" layim-event="msgbox" title="消息盒子">&#xe645;<span class="layui-anim"></span></li>',"{{# } }}","{{# if(d.base.find){ }}",'<li class="layui-icon layim-tool-find" layim-event="find" title="查找">&#xe608;</li>',"{{# } }}",'<li class="layui-icon layim-tool-skin" layim-event="skin" title="更换背景">&#xe61b;</li>',"{{# if(!d.base.copyright){ }}",'<li class="layui-icon layim-tool-about" layim-event="about" title="关于">&#xe60b;</li>',"{{# } }}","</ul>",'<div class="layui-layim-search"><input><label class="layui-icon" layim-event="closeSearch">&#x1007;</label></div>',"</div>"].join(""),t=['<ul class="layui-layim-skin">',"{{# layui.each(d.skin, function(index, item){ }}",'<li><img layim-event="setSkin" src="{{ item }}"></li>',"{{# }); }}",'<li layim-event="setSkin"><cite>简约</cite></li>',"</ul>"].join(""),p=['<div class="layim-chat layim-chat-{{d.data.type}}{{d.first ? " layui-show" : ""}}">','<div class="layui-unselect layim-chat-title">','<div class="layim-chat-other">','<img class="layim-{{ d.data.type }}{{ d.data.id }}" src="{{ d.data.avatar }}"><span class="layim-chat-username" layim-event="{{ d.data.type==="group" ? "groupMembers" : "" }}">{{ d.data.name||"佚名" }} {{d.data.temporary ? "<cite>临时会话</cite>" : ""}} {{# if(d.data.type==="group"){ }} <em class="layim-chat-members"></em><i class="layui-icon">&#xe61a;</i> {{# } }}</span>','<p class="layim-chat-status"></p>',"</div>","</div>",'<div class="layim-chat-main">',"<ul></ul>","</div>",'<div class="layim-chat-footer">','<div class="layui-unselect layim-chat-tool" data-json="{{encodeURIComponent(JSON.stringify(d.data))}}">','<span class="layui-icon layim-tool-face" title="选择表情" layim-event="face">&#xe60c;</span>',"{{# if(d.base && d.base.uploadImage){ }}",'<span class="layui-icon layim-tool-image" title="上传图片" layim-event="image">&#xe60d;<input type="file" name="file"></span>',"{{# }; }}","{{# if(d.base && d.base.uploadFile){ }}",'<span class="layui-icon layim-tool-image" title="发送文件" layim-event="image" data-type="file">&#xe61d;<input type="file" name="file"></span>',"{{# }; }}","{{# if(d.base && d.base.isAudio){ }}",'<span class="layui-icon layim-tool-audio" title="发送网络音频" layim-event="media" data-type="audio">&#xe6fc;</span>',"{{# }; }}","{{# if(d.base && d.base.isVideo){ }}",'<span class="layui-icon layim-tool-video" title="发送网络视频" layim-event="media" data-type="video">&#xe6ed;</span>',"{{# }; }}","{{# layui.each(d.base.tool, function(index, item){ }}",'<span class="layui-icon layim-tool-{{item.alias}}" title="{{item.title}}" layim-event="extend" lay-filter="{{ item.alias }}">{{item.icon}}</span>',"{{# }); }}","{{# if(d.base && d.base.chatLog){ }}",'<span class="layim-tool-log" layim-event="chatLog"><i class="layui-icon">&#xe60e;</i>聊天记录</span>',"{{# }; }}","</div>",'<div class="layim-chat-textarea"><textarea></textarea></div>','<div class="layim-chat-bottom">','<div class="layim-chat-send">',"{{# if(!d.base.brief){ }}",'<span class="layim-send-close" layim-event="closeThisChat">关闭</span>',"{{# } }}",'<span class="layim-send-btn" layim-event="send">发送</span>','<span class="layim-send-set" layim-event="setSend" lay-type="show"><em class="layui-edge"></em></span>','<ul class="layui-anim layim-menu-box">','<li {{d.local.sendHotKey !== "Ctrl+Enter" ? "class=layim-this" : ""}} layim-event="setSend" lay-type="Enter"><i class="layui-icon">&#xe618;</i>按Enter键发送消息</li>','<li {{d.local.sendHotKey === "Ctrl+Enter" ? "class=layim-this" : ""}} layim-event="setSend"  lay-type="Ctrl+Enter"><i class="layui-icon">&#xe618;</i>按Ctrl+Enter键发送消息</li>',"</ul>","</div>","</div>","</div>","</div>"].join(""),s=['<div class="layim-add-box">','<div class="layim-add-img"><img class="layui-circle" src="{{ d.data.avatar }}"><p>{{ d.data.name||"" }}</p></div>','<div class="layim-add-remark">','{{# if(d.data.type === "friend" && d.type === "setGroup"){ }}',"<p>选择分组</p>",'{{# } if(d.data.type === "friend"){ }}','<select class="layui-select" id="LAY_layimGroup">',"{{# layui.each(d.data.group, function(index, item){ }}",'<option value="{{ item.id }}">{{ item.groupname }}</option>',"{{# }); }}","</select>","{{# } }}",'{{# if(d.data.type === "group"){ }}',"<p>请输入验证信息</p>",'{{# } if(d.type !== "setGroup"){ }}','<textarea id="LAY_layimRemark" placeholder="验证信息" class="layui-textarea"></textarea>',"{{# } }}","</div>","</div>"].join(""),h=['<li {{ d.mine ? "class=layim-chat-mine" : "" }} {{# if(d.cid){ }}data-cid="{{d.cid}}"{{# } }}>','<div class="layim-chat-user"><img src="{{ d.avatar }}"><cite>',"{{# if(d.mine){ }}",'<i>{{ layui.data.date(d.timestamp) }}</i>{{ d.username||"佚名" }}',"{{# } else { }}",'{{ d.username||"佚名" }}<i>{{ layui.data.date(d.timestamp) }}</i>',"{{# } }}","</cite></div>",'<div class="layim-chat-text">{{ layui.data.content(d.content||"&nbsp") }}</div>',"</li>"].join(""),v='<li class="layim-{{ d.data.type }}{{ d.data.id }} layim-chatlist-{{ d.data.type }}{{ d.data.id }} layim-this" layim-event="tabChat"><img src="{{ d.data.avatar }}"><span>{{ d.data.name||"佚名" }}</span>{{# if(!d.base.brief){ }}<i class="layui-icon" layim-event="closeChat">&#x1007;</i>{{# } }}</li>',n=function(i){return i<10?"0"+(0|i):i};layui.data.date=function(i){var a=new Date(i||new Date);return a.getFullYear()+"-"+n(a.getMonth()+1)+"-"+n(a.getDate())+" "+n(a.getHours())+":"+n(a.getMinutes())+":"+n(a.getSeconds())},layui.data.content=function(i){var a=function(i){return new RegExp("\\n*\\["+(i||"")+"(code|pre|div|span|p|table|thead|th|tbody|tr|td|ul|li|ol|li|dl|dt|dd|h2|h3|h4|h5)([\\s\\S]*?)\\]\\n*","g")};return i=(i||"").replace(/&(?!#?[a-zA-Z0-9]+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#39;").replace(/"/g,"&quot;").replace(/@(\S+)(\s+?|$)/g,'@<a href="javascript:;">$1</a>$2').replace(/face\[([^\s\[\]]+?)\]/g,function(i){var a=i.replace(/^face/g,"");return'<img alt="'+a+'" title="'+a+'" src="'+Z[a]+'">'}).replace(/img\[([^\s]+?)\]/g,function(i){return'<img class="layui-layim-photos" src="'+i.replace(/(^img\[)|(\]$)/g,"")+'">'}).replace(/file\([\s\S]+?\)\[[\s\S]*?\]/g,function(i){var a=(i.match(/file\(([\s\S]+?)\)\[/)||[])[1],e=(i.match(/\)\[([\s\S]*?)\]/)||[])[1];return a?'<a class="layui-layim-file" href="'+a+'" download target="_blank"><i class="layui-icon">&#xe61e;</i><cite>'+(e||a)+"</cite></a>":i}).replace(/audio\[([^\s]+?)\]/g,function(i){return'<div class="layui-unselect layui-layim-audio" layim-event="playAudio" data-src="'+i.replace(/(^audio\[)|(\]$)/g,"")+'"><i class="layui-icon">&#xe652;</i><p>音频消息</p></div>'}).replace(/video\[([^\s]+?)\]/g,function(i){return'<div class="layui-unselect layui-layim-video" layim-event="playVideo" data-src="'+i.replace(/(^video\[)|(\]$)/g,"")+'"><i class="layui-icon">&#xe652;</i></div>'}).replace(/a\([\s\S]+?\)\[[\s\S]*?\]/g,function(i){var a=(i.match(/a\(([\s\S]+?)\)\[/)||[])[1],e=(i.match(/\)\[([\s\S]*?)\]/)||[])[1];return a?'<a href="'+a+'" target="_blank">'+(e||a)+"</a>":i}).replace(a(),"<$1 $2>").replace(a("/"),"</$1>").replace(/\n/g,"<br>")};var g,x,b,w,k,C,S=function(i,a,e){return i=i||{},r.ajax({url:i.url,type:i.type||"get",data:i.data,dataType:i.dataType||"json",cache:!1,success:function(i){0==i.code?a&&a(i.data||{}):u.msg(i.msg||(e||"Error")+": LAYIM_NOT_GET_DATA",{time:5e3})},error:function(i,a){window.console&&console.log&&console.error("LAYIM_DATE_ERROR："+a)}})},j={message:{},chat:[]},H=function(n){var i=n.init||{};if(mine=i.mine||{},local=layui.data("layim")[mine.id]||{},obj={base:n,local:local,mine:mine,history:local.history||{}},create=function(i){var a=i.mine||{},e=layui.data("layim")[a.id]||{},t={base:n,local:e,mine:a,friend:i.friend||[],group:i.group||[],history:e.history||{}};j=r.extend(j,t),L(d(l).render(t)),(e.close||n.min)&&T(),layui.each(m.ready,function(i,a){a&&a(t)})},j=r.extend(j,obj),n.brief)return layui.each(m.ready,function(i,a){a&&a(obj)});i.url?S(i,create,"INIT"):create(i)},L=function(i){return u.open({type:1,area:["260px","520px"],skin:"layui-box layui-layim",title:"&#8203;",offset:"rb",id:"layui-layim",shade:!1,anim:2,resize:!1,content:i,success:function(i){R(g=i),j.base.right&&i.css("margin-left","-"+j.base.right),x&&u.close(x.attr("times"));var a=[],e=i.find(".layim-list-history");e.find("li").each(function(){a.push(r(this).prop("outerHTML"))}),0<a.length&&(a.reverse(),e.html(a.join(""))),A(),ai.sign()},cancel:function(i){T();var a=layui.data("layim")[j.mine.id]||{};return a.close=!0,layui.data("layim",{key:j.mine.id,value:a}),!1}})},A=function(){g.on("contextmenu",function(i){return i.cancelBubble=!0,i.returnValue=!1});var t=function(){u.closeAll("tips")};g.find(".layim-list-history").on("contextmenu","li",function(i){var a=r(this),e='<ul data-id="'+a[0].id+'" data-index="'+a.data("index")+'"><li layim-event="menuHistory" data-type="one">移除该会话</li><li layim-event="menuHistory" data-type="all">清空全部会话列表</li></ul>';a.hasClass("layim-null")||(u.tips(e,this,{tips:1,time:0,anim:5,fixed:!0,skin:"layui-box layui-layim-contextmenu",success:function(i){var a=function(i){Q(i)};i.off("mousedown",a).on("mousedown",a)}}),r(document).off("mousedown",t).on("mousedown",t),r(window).off("resize",t).on("resize",t))})},T=function(i){return x&&u.close(x.attr("times")),g&&g.hide(),j.mine=j.mine||{},u.open({type:1,title:!1,id:"layui-layim-close",skin:"layui-box layui-layim-min layui-layim-close",shade:!1,closeBtn:!1,anim:2,offset:"rb",resize:!1,content:'<img src="'+(j.mine.avatar||layui.cache.dir+"css/pc/layim/skin/logo.jpg")+'"><span>'+(i||j.base.title||"我的LayIM")+"</span>",move:"#layui-layim-close img",success:function(i,a){x=i,j.base.right&&i.css("margin-left","-"+j.base.right),i.on("click",function(){u.close(a),g.show();var i=layui.data("layim")[j.mine.id]||{};delete i.close,layui.data("layim",{key:j.mine.id,value:i})})}})},z=function(a){a=a||{};var i=r("#layui-layim-chat"),e={data:a,base:j.base,local:j.local};if(!a.id)return u.msg("非法用户");if(i[0]){var t=b.find(".layim-chat-list"),n=t.find(".layim-chatlist-"+a.type+a.id),l=b.find(".layui-layer-max").hasClass("layui-layer-maxmin"),s=i.children(".layim-chat-box");return"none"===b.css("display")&&b.show(),w&&u.close(w.attr("times")),1!==t.find("li").length||n[0]||(l||b.css("width",800),t.css({height:b.height()}).show(),s.css("margin-left","200px")),n[0]||(t.append(d(v).render(e)),s.append(d(p).render(e)),I(a),E()),O(t.find(".layim-chatlist-"+a.type+a.id)),n[0]||V(),$(a),W(),k}e.first=!0;var o=k=u.open({type:1,area:"600px",skin:"layui-box layui-layim-chat",id:"layui-layim-chat",title:"&#8203;",shade:!1,maxmin:!0,offset:a.offset||"auto",anim:a.anim||0,closeBtn:!j.base.brief&&1,content:d('<ul class="layui-unselect layim-chat-list">'+v+'</ul><div class="layim-chat-box">'+p+"</div>").render(e),success:function(i){(b=i).css({"min-width":"500px","min-height":"420px"}),I(a),"function"==typeof a.success&&a.success(i),W(),R(i),$(a),V(),q(),layui.each(m.chatChange,function(i,a){a&&a(_())}),i.on("dblclick",".layui-layim-photos",function(){var i=this.src;u.close(z.photosIndex),u.photos({photos:{data:[{alt:"大图模式",src:i}]},shade:.01,closeBtn:2,anim:0,resize:!1,success:function(i,a){z.photosIndex=a}})})},full:function(i){u.style(o,{width:"100%",height:"100%"},!0),E()},resizing:E,restore:E,min:function(){return N(),!1},end:function(){u.closeAll("tips"),b=null}});return o},I=function(i){r(".layim-"+i.type+i.id).each(function(){r(this).hasClass("layim-list-gray")&&layui.layim.setFriendStatus(i.id,"offline")})},E=function(){var i=b.find(".layim-chat-list"),a=b.find(".layim-chat-main"),e=b.height();i.css({height:e}),a.css({height:e-20-80-158})},N=function(e){var i=e||_().data,t=layui.layim.cache().base;b&&!e&&b.hide(),u.close(N.index),N.index=u.open({type:1,title:!1,skin:"layui-box layui-layim-min",shade:!1,closeBtn:!1,anim:i.anim||2,offset:"b",move:"#layui-layim-min",resize:!1,area:["182px","50px"],content:'<img id="layui-layim-min" src="'+i.avatar+'"><span>'+i.name+"</span>",success:function(i,a){e||(w=i),t.minRight&&u.style(a,{left:r(window).width()-i.outerWidth()-parseFloat(t.minRight)}),i.find(".layui-layer-content span").on("click",function(){u.close(a),e?layui.each(j.chat,function(i,a){z(a)}):b.show(),e&&(j.chat=[],P())}),i.find(".layui-layer-content img").on("click",function(i){Q(i)})}})},M=function(n,l){return n=n||{},u.close(M.index),M.index=u.open({type:1,area:"430px",title:{friend:"添加好友",group:"加入群组"}[n.type]||"",shade:!1,resize:!1,btn:l?["确认","取消"]:["发送申请","关闭"],content:d(s).render({data:{name:n.username||n.groupname,avatar:n.avatar,group:n.group||parent.layui.layim.cache().friend||[],type:n.type},type:l}),yes:function(i,a){var e=a.find("#LAY_layimGroup"),t=a.find("#LAY_layimRemark");l?n.submit&&n.submit(e.val(),i):n.submit&&n.submit(e.val(),t.val(),i)}})},O=function(i,a){var e=-1===(i=i||r(".layim-chat-list ."+y)).index()?0:i.index(),t=".layim-chat",n=b.find(t).eq(e),l=b.find(".layui-layer-max").hasClass("layui-layer-maxmin");if(a){i.hasClass(y)&&O(0===e?i.next():i.prev());var s=b.find(t).length;return 1===s?u.close(k):(i.remove(),n.remove(),2===s&&(b.find(".layim-chat-list").hide(),l||b.css("width","600px"),b.find(".layim-chat-box").css("margin-left",0)),!1)}i.addClass(y).siblings().removeClass(y),n.addClass(o).siblings(t).removeClass(o),n.find("textarea").focus(),layui.each(m.chatChange,function(i,a){a&&a(_())}),q()},q=function(){var i=_();j.message[i.data.type+i.data.id]&&delete j.message[i.data.type+i.data.id]},_=function(){if(b){var i=r(".layim-chat-list ."+y).index(),a=b.find(".layim-chat").eq(i),e=JSON.parse(decodeURIComponent(a.find(".layim-chat-tool").data("json")));return{elem:a,data:e,textarea:a.find("textarea")}}},R=function(i){var a=(layui.data("layim")[j.mine.id]||{}).skin;i.css({"background-image":a?"url("+a+")":j.base.initSkin?"url("+layui.cache.dir+"css/modules/layim/skin/"+j.base.initSkin+")":"none"})},$=function(i){var a=layui.data("layim")[j.mine.id]||{},e={},t=a.history||{},n=t[i.type+i.id];if(g){var l=g.find(".layim-list-history");if(i.historyTime=(new Date).getTime(),t[i.type+i.id]=i,a.history=t,layui.data("layim",{key:j.mine.id,value:a}),!n){e[i.type+i.id]=i;var s=d(f({type:"history",item:"d.data"})).render({data:e});l.prepend(s),l.find(".layim-null").remove()}}},D=function(){var i={username:j.mine?j.mine.username:"访客",avatar:j.mine?j.mine.avatar:layui.cache.dir+"css/pc/layim/skin/logo.jpg",id:j.mine?j.mine.id:null,mine:!0},a=_(),e=a.elem.find(".layim-chat-main ul"),t=j.base.maxLength||3e3;if(i.content=a.textarea.val(),""!==i.content.replace(/\s/g,"")){if(i.content.length>t)return u.msg("内容最长不能超过"+t+"个字符");e.append(d(h).render(i));var n={mine:i,to:a.data},l={username:n.mine.username,avatar:n.mine.avatar,id:n.to.id,type:n.to.type,content:n.mine.content,timestamp:(new Date).getTime(),mine:!0};Y(l),layui.each(m.sendMessage,function(i,a){a&&a(n)})}P(),a.textarea.val("").focus()},J=function(i){if(i=i||{},window.Notification)if("granted"===Notification.permission)new Notification(i.title||"",{body:i.content||"",icon:i.avatar||"http://tp2.sinaimg.cn/5488749285/50/5719808192/1"});else Notification.requestPermission()},F=function(e){var i=r(".layim-chatlist-"+(e=e||{}).type+e.id),t={},a=i.index();if(e.timestamp=e.timestamp||(new Date).getTime(),e.fromid==j.mine.id&&(e.mine=!0),e.system||Y(e),JSON.parse(JSON.stringify(e)),j.base.voice&&function(){if(!(c.ie&&c.ie<9)){var i=document.createElement("audio");i.src=layui.cache.dir+"css/modules/layim/voice/"+j.base.voice,i.play()}}(),!b&&e.content||-1===a){var n;if(j.message[e.type+e.id])j.message[e.type+e.id].push(e);else if(j.message[e.type+e.id]=[e],"friend"===e.type)layui.each(j.friend,function(i,a){if(layui.each(a.list,function(i,a){if(a.id==e.id)return a.type="friend",a.name=a.username,j.chat.push(a),n=!0}),n)return!0}),n||(e.name=e.username,e.temporary=!0,j.chat.push(e));else if("group"===e.type){var l;layui.each(j.group,function(i,a){if(a.id==e.id)return a.type="group",a.name=a.groupname,j.chat.push(a),l=!0}),l||(e.name=e.groupname,j.chat.push(e))}else e.name=e.name||e.username||e.groupname,j.chat.push(e);if("group"===e.type&&layui.each(j.group,function(i,a){if(a.id==e.id)return t.avatar=a.avatar,!0}),!e.system)return j.base.notice&&J({title:"来自 "+e.username+" 的消息",content:e.content,avatar:t.avatar||e.avatar}),N({name:"收到新消息",avatar:t.avatar||e.avatar,anim:6})}if(b){var s=_();s.data.type+s.data.id!==e.type+e.id&&(i.addClass("layui-anim layer-anim-06"),setTimeout(function(){i.removeClass("layui-anim layer-anim-06")},300));var o=b.find(".layim-chat").eq(a).find(".layim-chat-main ul");e.system?-1!==a&&o.append('<li class="layim-chat-system"><span>'+e.content+"</span></li>"):""!==e.content.replace(/\s/g,"")&&o.append(d(h).render(e)),P()}},G="layui-anim-loop layer-anim-05",K=function(i){g.find(".layim-tool-msgbox").find("span").addClass(G).html(i)},Y=function(e){var i=layui.data("layim")[j.mine.id]||{};i.chatlog=i.chatlog||{};var t,a=i.chatlog[e.type+e.id];a?(layui.each(a,function(i,a){a.timestamp===e.timestamp&&a.type===e.type&&a.id===e.id&&a.content===e.content&&(t=!0)}),t||e.fromid==j.mine.id||a.push(e),20<a.length&&a.shift()):i.chatlog[e.type+e.id]=[e];layui.data("layim",{key:j.mine.id,value:i})},V=function(){var i=layui.data("layim")[j.mine.id]||{},a=_(),e=i.chatlog||{},t=a.elem.find(".layim-chat-main ul");layui.each(e[a.data.type+a.data.id],function(i,a){t.append(d(h).render(a))}),P()},B=function(e){var t,n={},i=g.find(".layim-list-"+e.type);if(j[e.type])if("friend"===e.type)layui.each(j.friend,function(i,a){if(e.groupname==a.id)return layui.each(j.friend[i].list,function(i,a){if(a.id==e.id)return t=!0}),t?u.msg("好友 ["+(e.username||"")+"] 已经存在列表中",{anim:6}):(j.friend[i].list=j.friend[i].list||[],(n[j.friend[i].list.length]=e).groupIndex=i,j.friend[i].list.push(e),!0)});else if("group"===e.type){if(layui.each(j.group,function(i,a){if(a.id==e.id)return t=!0}),t)return u.msg("您已是 ["+(e.groupname||"")+"] 的群成员",{anim:6});n[j.group.length]=e,j.group.push(e)}if(!t){var a=d(f({type:e.type,item:"d.data",index:"friend"===e.type?"data.groupIndex":null})).render({data:n});if("friend"===e.type){var l=i.find(">li").eq(e.groupIndex);l.find(".layui-layim-list").append(a),l.find(".layim-count").html(j.friend[e.groupIndex].list.length),l.find(".layim-null")[0]&&l.find(".layim-null").remove()}else"group"===e.type&&(i.append(a),i.find(".layim-null")[0]&&i.find(".layim-null").remove())}},U=function(n){var l=g.find(".layim-list-"+n.type);j[n.type]&&("friend"===n.type?layui.each(j.friend,function(t,i){layui.each(i.list,function(i,a){if(n.id==a.id){var e=l.find(">li").eq(t);e.find(".layui-layim-list>li");return e.find(".layui-layim-list>li").eq(i).remove(),j.friend[t].list.splice(i,1),e.find(".layim-count").html(j.friend[t].list.length),0===j.friend[t].list.length&&e.find(".layui-layim-list").html('<li class="layim-null">该分组下已无好友了</li>'),!0}})}):"group"===n.type&&layui.each(j.group,function(i,a){if(n.id==a.id)return l.find(">li").eq(i).remove(),j.group.splice(i,1),0===j.group.length&&l.html('<li class="layim-null">暂无群组</li>'),!0}))},P=function(){var i=_().elem.find(".layim-chat-main"),a=i.find("ul"),e=a.find("li").length;if(20<=e){var t=a.find("li").eq(0);a.prev().hasClass("layim-chat-system")||a.before('<div class="layim-chat-system"><span layim-event="chatLog">查看更多记录</span></div>'),20<e&&t.remove()}i.scrollTop(i[0].scrollHeight+1e3),i.find("ul li:last").find("img").load(function(){i.scrollTop(i[0].scrollHeight+1e3)})},W=function(){var t=_().textarea;t.focus(),t.off("keydown").on("keydown",function(i){var a=layui.data("layim")[j.mine.id]||{},e=i.keyCode;if("Ctrl+Enter"!==a.sendHotKey){if(13===e){if(i.ctrlKey)return t.val(t.val()+"\n");if(i.shiftKey)return;i.preventDefault(),D()}}else i.ctrlKey&&13===e&&D()})},Z=(C={},layui.each(["[微笑]","[嘻嘻]","[哈哈]","[可爱]","[可怜]","[挖鼻]","[吃惊]","[害羞]","[挤眼]","[闭嘴]","[鄙视]","[爱你]","[泪]","[偷笑]","[亲亲]","[生病]","[太开心]","[白眼]","[右哼哼]","[左哼哼]","[嘘]","[衰]","[委屈]","[吐]","[哈欠]","[抱抱]","[怒]","[疑问]","[馋嘴]","[拜拜]","[思考]","[汗]","[困]","[睡]","[钱]","[失望]","[酷]","[色]","[哼]","[鼓掌]","[晕]","[悲伤]","[抓狂]","[黑线]","[阴险]","[怒骂]","[互粉]","[心]","[伤心]","[猪头]","[熊猫]","[兔子]","[ok]","[耶]","[good]","[NO]","[赞]","[来]","[弱]","[草泥马]","[神马]","[囧]","[浮云]","[给力]","[围观]","[威武]","[奥特曼]","[礼物]","[钟]","[话筒]","[蜡烛]","[蛋糕]"],function(i,a){C[a]=layui.cache.dir+"images/face/"+i+".gif"}),C),Q=layui.stope,X=function(i,a){var e,t=i.value;i.focus(),document.selection?(e=document.selection.createRange(),document.selection.empty(),e.text=a):(e=[t.substring(0,i.selectionStart),a,t.substr(i.selectionEnd)],i.focus(),i.value=e.join(""))},ii="layui-anim-upbit",ai={status:function(i,a){var e=function(){i.next().hide().removeClass(ii)},t=i.attr("lay-type");if("show"===t)Q(a),i.next().show().addClass(ii),r(document).off("click",e).on("click",e);else{var n=i.parent().prev();i.addClass(y).siblings().removeClass(y),n.html(i.find("cite").html()),n.removeClass("layim-status-"+("online"===t?"hide":"online")).addClass("layim-status-"+t),layui.each(m.online,function(i,a){a&&a(t)})}},sign:function(){var i=g.find(".layui-layim-remark");i.on("change",function(){var e=this.value;layui.each(m.sign,function(i,a){a&&a(e)})}),i.on("keyup",function(i){13===i.keyCode&&this.blur()})},tab:function(i){var a,e=".layim-tab-content",t=g.find(".layui-layim-tab>li");"number"==typeof i?(a=i,i=t.eq(a)):a=i.index(),2<a?t.removeClass(y):(ai.tab.index=a,i.addClass(y).siblings().removeClass(y)),g.find(e).eq(a).addClass(o).siblings(e).removeClass(o)},spread:function(i){var a=i.attr("lay-type"),e="true"===a?"false":"true",t=layui.data("layim")[j.mine.id]||{};i.next()["true"===a?"removeClass":"addClass"](o),t["spread"+i.parent().index()]=e,layui.data("layim",{key:j.mine.id,value:t}),i.attr("lay-type",e),i.find(".layui-icon").html("true"===e?"&#xe61a;":"&#xe602;")},search:function(i){var a=g.find(".layui-layim-search"),r=g.find("#layui-layim-search"),u=a.find("input"),e=function(i){var a=u.val().replace(/\s/);if(""===a)ai.tab(0|ai.tab.index);else{for(var e=[],t=j.friend||[],n=j.group||[],l="",s=0;s<t.length;s++)for(var o=0;o<(t[s].list||[]).length;o++)-1!==t[s].list[o].username.indexOf(a)&&(t[s].list[o].type="friend",t[s].list[o].index=s,t[s].list[o].list=o,e.push(t[s].list[o]));for(var d=0;d<n.length;d++)-1!==n[d].groupname.indexOf(a)&&(n[d].type="group",n[d].index=d,n[d].list=d,e.push(n[d]));if(0<e.length)for(var c=0;c<e.length;c++)l+='<li layim-event="chat" data-type="'+e[c].type+'" data-index="'+e[c].index+'" data-list="'+e[c].list+'"><img src="'+e[c].avatar+'"><span>'+(e[c].username||e[c].groupname||"佚名")+"</span><p>"+(e[c].remark||e[c].sign||"")+"</p></li>";else l='<li class="layim-null">无搜索结果</li>';r.html(l),ai.tab(3)}};!j.base.isfriend&&j.base.isgroup?ai.tab.index=1:j.base.isfriend||j.base.isgroup||(ai.tab.index=2),a.show(),u.focus(),u.off("keyup",e).on("keyup",e)},closeSearch:function(i){i.parent().hide(),ai.tab(0|ai.tab.index)},msgbox:function(){var i=g.find(".layim-tool-msgbox");return u.close(ai.msgbox.index),i.find("span").removeClass(G).html(""),ai.msgbox.index=u.open({type:2,title:"消息盒子",shade:!1,maxmin:!0,area:["600px","520px"],skin:"layui-box layui-layer-border",resize:!1,content:j.base.msgbox})},find:function(){return u.close(ai.find.index),ai.find.index=u.open({type:2,title:"查找",shade:!1,maxmin:!0,area:["1000px","520px"],skin:"layui-box layui-layer-border",resize:!1,content:j.base.find})},skin:function(){u.open({type:1,title:"更换背景",shade:!1,area:"300px",skin:"layui-box layui-layer-border",id:"layui-layim-skin",zIndex:66666666,resize:!1,content:d(t).render({skin:j.base.skin})})},about:function(){u.alert('版本： 3.7.6<br>版权所有：<a href="http://layim.layui.com" target="_blank">layim.layui.com</a>',{title:"关于 LayIM",shade:!1})},setSkin:function(i){var t=i.attr("src"),a=layui.data("layim")[j.mine.id]||{};(a.skin=t)||delete a.skin,layui.data("layim",{key:j.mine.id,value:a});try{g.css({"background-image":t?"url("+t+")":"none"}),b.css({"background-image":t?"url("+t+")":"none"})}catch(i){}layui.each(m.setSkin,function(i,a){var e=(t||"").replace(layui.cache.dir+"css/modules/layim/skin/","");a&&a(e,t)})},chat:function(i){var a=layui.data("layim")[j.mine.id]||{},e=i.data("type"),t=i.data("index"),n=i.attr("data-list")||i.index(),l={};"friend"===e?l=j[e][t].list[n]:"group"===e?l=j[e][n]:"history"===e&&(l=(a.history||{})[t]||{}),l.name=l.name||l.username||l.groupname,"history"!==e&&(l.type=e),z(l)},tabChat:function(i){O(i)},closeChat:function(i,a){O(i.parent(),1),Q(a)},closeThisChat:function(){O(null,1)},groupMembers:function(d,i){var a=d.find(".layui-icon"),c=function(){a.html("&#xe61a;"),d.data("down",null),u.close(ai.groupMembers.index)},e=function(i){Q(i)};d.data("down")?c():(a.html("&#xe619;"),d.data("down",!0),ai.groupMembers.index=u.tips('<ul class="layim-members-list"></ul>',d,{tips:3,time:0,anim:5,fixed:!0,skin:"layui-box layui-layim-members",success:function(i){var a=j.base.members||{},e=_(),t=i.find(".layim-members-list"),n="",l={},s=b.find(".layui-layer-max").hasClass("layui-layer-maxmin"),o="none"===b.find(".layim-chat-list").css("display");s&&t.css({width:r(window).width()-22-(o||200)}),a.data=r.extend(a.data,{id:e.data.id}),S(a,function(e){layui.each(e.list,function(i,a){n+='<li data-uid="'+a.id+'"><a href="javascript:;"><img src="'+a.avatar+'"><cite>'+a.username+"</cite></a></li>",l[a.id]=a}),t.html(n),d.find(".layim-chat-members").html(e.members||(e.list||[]).length+"人"),t.find("li").on("click",function(){var i=r(this).data("uid"),a=l[i];z({name:a.username,type:"friend",avatar:a.avatar,id:a.id}),c()}),layui.each(m.members,function(i,a){a&&a(e)})}),i.on("mousedown",function(i){Q(i)})}}),r(document).off("mousedown",c).on("mousedown",c),r(window).off("resize",c).on("resize",c),d.off("mousedown",e).on("mousedown",e))},send:function(){D()},setSend:function(i,a){var e=ai.setSend.box=i.siblings(".layim-menu-box"),t=i.attr("lay-type");if("show"===t)Q(a),e.show().addClass(ii),r(document).off("click",ai.setSendHide).on("click",ai.setSendHide);else{i.addClass(y).siblings().removeClass(y);var n=layui.data("layim")[j.mine.id]||{};n.sendHotKey=t,layui.data("layim",{key:j.mine.id,value:n}),ai.setSendHide(a,i.parent())}},setSendHide:function(i,a){(a||ai.setSend.box).hide().removeClass(ii)},face:function(i,a){var e="",t=_();for(var n in Z)e+='<li title="'+n+'"><img src="'+Z[n]+'"></li>';e='<ul class="layui-clear layim-face-list">'+e+"</ul>",ai.face.index=u.tips(e,i,{tips:1,time:0,fixed:!0,skin:"layui-box layui-layim-face",success:function(i){i.find(".layim-face-list>li").on("mousedown",function(i){Q(i)}).on("click",function(){X(t.textarea[0],"face"+this.title+" "),u.close(ai.face.index)})}}),r(document).off("mousedown",ai.faceHide).on("mousedown",ai.faceHide),r(window).off("resize",ai.faceHide).on("resize",ai.faceHide),Q(a)},faceHide:function(){u.close(ai.face.index)},image:function(i){var a=i.data("type")||"images",e=_(),t=j.base[{images:"uploadImage",file:"uploadFile"}[a]]||{};layui.upload.render({url:t.url||"",method:t.type,elem:i.find("input")[0],accept:a,done:function(i){0==i.code?(i.data=i.data||{},"images"===a?X(e.textarea[0],"img["+(i.data.src||"")+"]"):"file"===a&&X(e.textarea[0],"file("+(i.data.src||"")+")["+(i.data.name||"下载文件")+"]"),D()):u.msg(i.msg||"上传失败")}})},media:function(i){var e=i.data("type"),t=_();u.prompt({title:"请输入网络"+{audio:"音频",video:"视频"}[e]+"地址",shade:!1,offset:[i.offset().top-r(window).scrollTop()-158+"px",i.offset().left+"px"]},function(i,a){X(t.textarea[0],e+"["+i+"]"),D(),u.close(a)})},extend:function(e){var i=e.attr("lay-filter"),t=_();layui.each(m["tool("+i+")"],function(i,a){a&&a.call(e,function(i){X(t.textarea[0],i)},D,t)})},playAudio:function(i){var a=i.data("audio"),e=a||document.createElement("audio"),t=function(){e.pause(),i.removeAttr("status"),i.find("i").html("&#xe652;")};return i.data("error")?u.msg("播放音频源异常"):e.play?void(i.attr("status")?t():(a||(e.src=i.data("src")),e.play(),i.attr("status","pause"),i.data("audio",e),i.find("i").html("&#xe651;"),e.onended=function(){t()},e.onerror=function(){u.msg("播放音频源异常"),i.data("error",!0),t()})):u.msg("您的浏览器不支持audio")},playVideo:function(i){var a=i.data("src");if(!document.createElement("video").play)return u.msg("您的浏览器不支持video");u.close(ai.playVideo.index),ai.playVideo.index=u.open({type:1,title:"播放视频",area:["460px","300px"],maxmin:!0,shade:!1,content:'<div style="background-color: #000; height: 100%;"><video style="position: absolute; width: 100%; height: 100%;" src="'+a+'" loop="loop" autoplay="autoplay"></video></div>'})},chatLog:function(i){var a=_();return j.base.chatLog?(u.close(ai.chatLog.index),ai.chatLog.index=u.open({type:2,maxmin:!0,title:"与 "+a.data.name+" 的聊天记录",area:["450px","100%"],shade:!1,offset:"rb",skin:"layui-box",anim:2,id:"layui-layim-chatlog",content:j.base.chatLog+"?id="+a.data.id+"&type="+a.data.type})):u.msg("未开启更多聊天记录")},menuHistory:function(i,a){var e=layui.data("layim")[j.mine.id]||{},t=i.parent(),n=i.data("type"),l=g.find(".layim-list-history"),s='<li class="layim-null">暂无历史会话</li>';if("one"===n){var o=e.history;delete o[t.data("index")],e.history=o,layui.data("layim",{key:j.mine.id,value:e}),r("#"+t.data("id")).remove(),0===l.find("li").length&&l.html(s)}else"all"===n&&(delete e.history,layui.data("layim",{key:j.mine.id,value:e}),l.html(s));u.closeAll("tips")}};i("layim",new e)}).addcss("modules/layim/layim.css?v=3.7.6","skinlayimcss");